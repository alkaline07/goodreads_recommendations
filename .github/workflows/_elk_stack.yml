name: ELK Stack (CI/Testing)

on:
  workflow_call:
    inputs:
      wait_for_healthy:
        description: 'Wait for ELK stack to be healthy before continuing'
        required: false
        type: boolean
        default: true
      elasticsearch_memory:
        description: 'Elasticsearch JVM heap size (e.g., 512m)'
        required: false
        type: string
        default: '512m'
      expose_kibana:
        description: 'Expose Kibana UI via ngrok'
        required: false
        type: boolean
        default: false
    outputs:
      elk_status:
        description: 'ELK stack status (healthy/unhealthy)'
        value: ${{ jobs.start-elk.outputs.elk_status }}
      kibana_url:
        description: 'Kibana URL if exposed via ngrok'
        value: ${{ jobs.start-elk.outputs.kibana_url }}
  workflow_dispatch:
    inputs:
      wait_for_healthy:
        description: 'Wait for ELK stack to be healthy'
        required: false
        type: boolean
        default: true
      expose_kibana:
        description: 'Expose Kibana UI via ngrok'
        required: false
        type: boolean
        default: true

env:
  COMPOSE_FILE: docker-compose.elk.yaml

jobs:
  start-elk:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      elk_status: ${{ steps.health_check.outputs.status }}
      kibana_url: ${{ steps.kibana_tunnel.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure system for Elasticsearch
        run: |
          sudo sysctl -w vm.max_map_count=262144
          echo "vm.max_map_count=262144" | sudo tee -a /etc/sysctl.conf

      - name: Create required directories
        run: |
          mkdir -p logs
          chmod -R 777 logs

      - name: Update Elasticsearch memory settings
        if: ${{ inputs.elasticsearch_memory != '512m' }}
        run: |
          sed -i "s/ES_JAVA_OPTS=-Xms512m -Xmx512m/ES_JAVA_OPTS=-Xms${{ inputs.elasticsearch_memory }} -Xmx${{ inputs.elasticsearch_memory }}/g" docker-compose.elk.yaml

      - name: Start ELK stack
        run: |
          echo "Starting ELK stack..."
          docker compose -f docker-compose.elk.yaml up -d
          
          echo "Containers started:"
          docker compose -f docker-compose.elk.yaml ps

      - name: Wait for Elasticsearch
        id: wait_es
        run: |
          echo "Waiting for Elasticsearch to be ready..."
          
          MAX_RETRIES=60
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -s http://localhost:9200/_cluster/health | grep -q '"status"'; then
              ES_STATUS=$(curl -s http://localhost:9200/_cluster/health | jq -r '.status')
              echo "Elasticsearch status: $ES_STATUS"
              
              if [ "$ES_STATUS" = "green" ] || [ "$ES_STATUS" = "yellow" ]; then
                echo "Elasticsearch is ready!"
                echo "es_ready=true" >> $GITHUB_OUTPUT
                break
              fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for Elasticsearch... (attempt $RETRY_COUNT/$MAX_RETRIES)"
            sleep 5
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "ERROR: Elasticsearch failed to become ready"
            docker logs elasticsearch --tail 50
            echo "es_ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Wait for Logstash
        id: wait_logstash
        run: |
          echo "Waiting for Logstash to be ready..."
          
          MAX_RETRIES=40
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -s http://localhost:9600/_node/stats | grep -q '"status"'; then
              echo "Logstash is ready!"
              echo "logstash_ready=true" >> $GITHUB_OUTPUT
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for Logstash... (attempt $RETRY_COUNT/$MAX_RETRIES)"
            sleep 5
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "WARNING: Logstash may not be fully ready, but continuing..."
            echo "logstash_ready=false" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Kibana
        id: wait_kibana
        run: |
          echo "Waiting for Kibana to be ready..."
          
          MAX_RETRIES=40
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            KIBANA_STATUS=$(curl -s http://localhost:5601/api/status | jq -r '.status.overall.state' 2>/dev/null || echo "not_ready")
            
            if [ "$KIBANA_STATUS" = "green" ] || [ "$KIBANA_STATUS" = "yellow" ]; then
              echo "Kibana is ready! Status: $KIBANA_STATUS"
              echo "kibana_ready=true" >> $GITHUB_OUTPUT
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Waiting for Kibana... (attempt $RETRY_COUNT/$MAX_RETRIES, status: $KIBANA_STATUS)"
            sleep 5
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "WARNING: Kibana may not be fully ready, but continuing..."
            echo "kibana_ready=false" >> $GITHUB_OUTPUT
          fi

      - name: ELK Stack Health Check
        id: health_check
        run: |
          echo "=========================================="
          echo "ELK Stack Health Check"
          echo "=========================================="
          
          ES_HEALTH=$(curl -s http://localhost:9200/_cluster/health)
          echo "Elasticsearch Cluster Health:"
          echo "$ES_HEALTH" | jq .
          
          echo ""
          echo "Elasticsearch Indices:"
          curl -s http://localhost:9200/_cat/indices?v || echo "No indices yet"
          
          echo ""
          echo "Container Status:"
          docker compose -f docker-compose.elk.yaml ps
          
          ES_STATUS=$(echo "$ES_HEALTH" | jq -r '.status')
          if [ "$ES_STATUS" = "green" ] || [ "$ES_STATUS" = "yellow" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo ""
            echo "ELK stack is HEALTHY"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo ""
            echo "ELK stack is UNHEALTHY"
            exit 1
          fi

      - name: Setup Kibana tunnel (ngrok)
        id: kibana_tunnel
        if: ${{ inputs.expose_kibana == true }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y
          
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ngrok http 5601 --log=stdout > ngrok-kibana.log &
          
          sleep 10
          
          KIBANA_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          
          if [ -z "$KIBANA_URL" ] || [ "$KIBANA_URL" = "null" ]; then
            echo "WARNING: Failed to get ngrok URL for Kibana"
            echo "url=" >> $GITHUB_OUTPUT
          else
            echo "url=$KIBANA_URL" >> $GITHUB_OUTPUT
            echo ""
            echo "=========================================="
            echo "Kibana UI is now publicly accessible!"
            echo "=========================================="
            echo "URL: $KIBANA_URL"
            echo "=========================================="
            echo "::notice title=Kibana Access::Access Kibana at $KIBANA_URL"
          fi

      - name: Create test log entry
        run: |
          echo '{"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","level":"INFO","logger":"elk-test","message":"ELK stack initialized successfully in GitHub Actions"}' | \
            curl -X POST "http://localhost:9200/goodreads-logs-$(date +%Y.%m.%d)/_doc" \
              -H "Content-Type: application/json" \
              -d @-
          
          echo ""
          echo "Test log entry created successfully"

      - name: Display ELK Stack Summary
        run: |
          echo "=========================================="
          echo "ELK Stack Summary"
          echo "=========================================="
          echo "Elasticsearch: http://localhost:9200"
          echo "Logstash:      http://localhost:9600"
          echo "Kibana:        http://localhost:5601"
          echo "Filebeat:      Collecting container logs"
          echo ""
          echo "Log Index Pattern: goodreads-logs-*"
          echo "=========================================="
          
          if [ -n "${{ steps.kibana_tunnel.outputs.url }}" ]; then
            echo ""
            echo "External Access:"
            echo "Kibana URL: ${{ steps.kibana_tunnel.outputs.url }}"
          fi
