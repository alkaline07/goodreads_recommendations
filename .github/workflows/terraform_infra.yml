name: Terraform Infrastructure
run-name: Deploy infrastructure with Terraform

on:
  workflow_call:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: false
        type: string
        default: 'apply'
      
      auto_approve:
        description: 'Auto-approve apply/destroy'
        required: false
        type: boolean
        default: false
    
    secrets:
      GCP_CREDENTIALS:
        required: true
      CALLER_GITHUB_TOKEN:
        required: false

  push:
    paths:
      - 'terraform/**'
    branches:
      - master
      - main
  
  pull_request:
    paths:
      - 'terraform/**'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      
      auto_approve:
        description: 'Auto-approve apply/destroy (use with caution)'
        required: false
        type: boolean
        default: false

concurrency:
  group: terraform-${{ github.repository }}
  cancel-in-progress: false

env:
  TF_VERSION: '1.6.0'
  TF_WORKING_DIR: './terraform'
  TF_LOCK_TIMEOUT: '300s'

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup GCP Project ID
        id: setup
        run: |
          echo "Getting project ID from credentials..."
          PROJECT_ID=$(echo '${{ secrets.GCP_CREDENTIALS }}' | jq -r '.project_id')
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Project ID: $PROJECT_ID"

      - name: Get selected model name
        id: model
        run: |
          if [ -f "docs/bias_reports/model_selection_report.json" ]; then
            MODEL_NAME=$(jq -r '.selected_model.model_name // "boosted_tree_regressor"' docs/bias_reports/model_selection_report.json)
          else
            MODEL_NAME="boosted_tree_regressor"
            echo "‚ö†Ô∏è  Model selection report not found, using default: $MODEL_NAME"
          fi
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "Selected model: goodreads_$MODEL_NAME"

      - name: Create terraform.tfvars
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          cat > terraform.tfvars << EOF
          project_id            = "${{ steps.setup.outputs.project_id }}"
          region                = "us-central1"
          environment           = "prod"
          model_display_name    = "goodreads_${{ steps.model.outputs.model_name }}"
          endpoint_display_name = "goodreads-recommendation-endpoint"
          min_replica_count     = 1
          max_replica_count     = 3
          machine_type          = "n1-standard-2"
          enable_logging        = true
          enable_monitoring     = true
          traffic_split_percentage = 100
          create_service_accounts = true
          create_logging_metrics  = true
          EOF
          
          echo "‚úÖ Created terraform.tfvars"

      - name: Terraform Init
        id: init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Clear stale locks
        run: |
          LOCK_FILE="gs://recommendation-system-475301-terraform-state/model-deployment/default.tflock"
          if gsutil -q stat "$LOCK_FILE" 2>/dev/null; then
            echo "Found existing lock file, removing stale lock..."
            gsutil rm "$LOCK_FILE" || true
            echo "Stale lock removed"
          else
            echo "No stale lock found"
          fi

      - name: Terraform Validate
        id: validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate -no-color

      - name: Terraform Format Check
        id: fmt
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -no-color -out=tfplan -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}
          echo "plan_exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Save Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}/tfplan
          retention-days: 5

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Generate Plan Summary
        if: always()
        run: |
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ steps.fmt.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Init | ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ steps.validate.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan | ${{ steps.plan.outcome }} |" >> $GITHUB_STEP_SUMMARY

  terraform-apply:
    name: Terraform Apply
    needs: terraform-plan
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_call' && inputs.action == 'apply') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'))
    
    environment: 
      name: production
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup GCP Project ID
        id: setup
        run: |
          PROJECT_ID=$(echo '${{ secrets.GCP_CREDENTIALS }}' | jq -r '.project_id')
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT

      - name: Get selected model name
        id: model
        run: |
          if [ -f "docs/bias_reports/model_selection_report.json" ]; then
            MODEL_NAME=$(jq -r '.selected_model.model_name // "boosted_tree_regressor"' docs/bias_reports/model_selection_report.json)
          else
            MODEL_NAME="boosted_tree_regressor"
            echo "‚ö†Ô∏è  Model selection report not found, using default: $MODEL_NAME"
          fi
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "Selected model: goodreads_$MODEL_NAME"

      - name: Create terraform.tfvars
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          cat > terraform.tfvars << EOF
          project_id            = "${{ steps.setup.outputs.project_id }}"
          region                = "us-central1"
          environment           = "prod"
          model_display_name    = "goodreads_${{ steps.model.outputs.model_name }}"
          endpoint_display_name = "goodreads-recommendation-endpoint"
          min_replica_count     = 1
          max_replica_count     = 3
          machine_type          = "n1-standard-2"
          enable_logging        = true
          enable_monitoring     = true
          traffic_split_percentage = 100
          create_service_accounts = true
          create_logging_metrics  = true
          EOF

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Clear stale locks
        run: |
          LOCK_FILE="gs://recommendation-system-475301-terraform-state/model-deployment/default.tflock"
          if gsutil -q stat "$LOCK_FILE" 2>/dev/null; then
            echo "Found existing lock file, removing stale lock..."
            gsutil rm "$LOCK_FILE" || true
            echo "Stale lock removed"
          else
            echo "No stale lock found"
          fi

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" == "true" ]; then
            terraform apply -auto-approve -lock-timeout=${{ env.TF_LOCK_TIMEOUT }} tfplan
          else
            terraform apply -lock-timeout=${{ env.TF_LOCK_TIMEOUT }} tfplan
          fi

      - name: Terraform Output
        id: output
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform output -json > terraform_outputs.json
          cat terraform_outputs.json

      - name: Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}/terraform_outputs.json
          retention-days: 30

      - name: Generate Apply Summary
        run: |
          echo "## Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat ${{ env.TF_WORKING_DIR }}/terraform_outputs.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    environment:
      name: production-destroy
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Setup GCP Project ID
        id: setup
        run: |
          PROJECT_ID=$(echo '${{ secrets.GCP_CREDENTIALS }}' | jq -r '.project_id')
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT

      - name: Get selected model name
        id: model
        run: |
          if [ -f "docs/bias_reports/model_selection_report.json" ]; then
            MODEL_NAME=$(jq -r '.selected_model.model_name // "boosted_tree_regressor"' docs/bias_reports/model_selection_report.json)
          else
            MODEL_NAME="boosted_tree_regressor"
            echo "‚ö†Ô∏è  Model selection report not found, using default: $MODEL_NAME"
          fi
          echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "Selected model: goodreads_$MODEL_NAME"

      - name: Create terraform.tfvars
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          cat > terraform.tfvars << EOF
          project_id            = "${{ steps.setup.outputs.project_id }}"
          region                = "us-central1"
          environment           = "prod"
          model_display_name    = "goodreads_${{ steps.model.outputs.model_name }}"
          endpoint_display_name = "goodreads-recommendation-endpoint"
          min_replica_count     = 1
          max_replica_count     = 3
          machine_type          = "n1-standard-2"
          enable_logging        = true
          enable_monitoring     = true
          traffic_split_percentage = 100
          create_service_accounts = true
          create_logging_metrics  = true
          EOF

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Clear stale locks
        run: |
          LOCK_FILE="gs://recommendation-system-475301-terraform-state/model-deployment/default.tflock"
          if gsutil -q stat "$LOCK_FILE" 2>/dev/null; then
            echo "Found existing lock file, removing stale lock..."
            gsutil rm "$LOCK_FILE" || true
            echo "Stale lock removed"
          else
            echo "No stale lock found"
          fi

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" == "true" ]; then
            terraform destroy -auto-approve -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}
          else
            terraform destroy -lock-timeout=${{ env.TF_LOCK_TIMEOUT }}
          fi

      - name: Generate Destroy Summary
        if: always()
        run: |
          echo "## Terraform Destroy Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All infrastructure has been destroyed." >> $GITHUB_STEP_SUMMARY
